<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous" />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .select-colour {
      height: 30px;
      width: 30px;
    }

    .select-colour:hover {
      box-shadow: 0px 0px 8px grey;
    }

    .selected {
      box-shadow: 0px 0px 8px grey;
    }

    .buttons>input:nth-child(1) {
      margin-right: 1rem;
    }

    .buttons>input {
      margin-top: 2rem;
    }

    canvas {
      border: 5px solid;
      display: block;
      width: 565px;
      height: 560px;
    }

    .colors {
      display: grid;
      gap: 10px;
      grid-template-columns: 2rem 2rem 2rem 2rem;
      grid-template-rows: auto auto auto auto;
    }

    .options {
      display: block;
      width: 100%;
    }

    #app {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: row;
      column-gap: 4rem;
    }
  </style>
</head>
<script type="text/javascript">
  var canvas,
    ctx,
    flag = false,
    prevX = 0,
    currX = 0,
    prevY = 0,
    currY = 0,
    dot_flag = false;

  var x = "black",
    y = 2;

  function init() {
    canvas = document.getElementById("can");
    ctx = canvas.getContext("2d");
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    w = canvas.width;
    h = canvas.height;
    color(null);

    canvas.addEventListener(
      "mousemove",
      function (e) {
        findxy("move", e, "");
      },
      false
    );
    canvas.addEventListener(
      "mousedown",
      function (e) {
        findxy("down", e, "");
      },
      false
    );
    canvas.addEventListener(
      "mouseup",
      function (e) {
        findxy("up", e, "");
      },
      false
    );
    canvas.addEventListener(
      "mouseout",
      function (e) {
        findxy("out", e, "");
      },
      false
    );

    canvas.addEventListener(
      "touchmove",
      function (e) {
        findxy("move", e, "touch");
      },
      false
    );
    canvas.addEventListener(
      "touchstart",
      function (e) {
        findxy("down", e, "touch");
      },
      false
    );
    canvas.addEventListener(
      "touchend",
      function (e) {
        findxy("up", e, "touch");
      },
      false
    );
  }

  function color(event) {
    ctx.globalCompositeOperation = 'source-over'
    if (!event) {
      x = "rgb(121,231,245)"
    }
    else {
      var bgColor = window.getComputedStyle(event.target).backgroundColor;
      if (bgColor.startsWith("#")) {
        // Convert #RRGGBB format to rgb(r, g, b) format
        var hex = bgColor.substring(1);
        var r = parseInt(hex.substring(0, 2), 16);
        var g = parseInt(hex.substring(2, 4), 16);
        var b = parseInt(hex.substring(4, 6), 16);
        bgColor = "rgb(" + r + ", " + g + ", " + b + ")";
      }
      x = bgColor;
      if (x == "rgb(255, 255, 255)") y = 14;
      else y = 2;
      var prevSelected = document.getElementsByClassName("selected");
      if (prevSelected.length > 0) {
        prevSelected[0].classList.remove("selected");
      }
      event.target.classList.add("selected");
    }
  }

  function draw() {
    ctx.beginPath();
    ctx.moveTo(prevX, prevY);
    ctx.lineTo(currX, currY);
    ctx.strokeStyle = x;
    ctx.lineWidth = y;
    ctx.stroke();
    ctx.closePath();
  }

  function erase() {
    ctx.clearRect(0, 0, w, h);
    document.getElementById("canvasimg").style.display = "none";
  }

  function download() {
    var canvas = document.getElementById("can");
    var submitBtn = document.getElementById("download");

    submitBtn.addEventListener("click", () => {
      var dataURL = canvas.toDataURL("image/png");

      fetch("/upload-canvas", {
        method: "POST",
        body: JSON.stringify({ dataURL }),
        headers: { "Content-Type": "application/json" },
      })
        .then((response) => response.json())
        .then((data) => console.log(data))
        .catch((error) => console.error(error));
    });
  }

  function findxy(res, e, source) {
    if (source) {
      var clientX = e.changedTouches[0].clientX;
      var clientY = e.changedTouches[0].clientY;
    } else {
      var clientX = e.clientX;
      var clientY = e.clientY;
    }

    if (res == "down") {
      prevX = currX;
      prevY = currY;
      currX = clientX - canvas.getBoundingClientRect().left;
      currY = clientY - canvas.getBoundingClientRect().top;

      flag = true;
      dot_flag = true;
      if (dot_flag) {
        ctx.beginPath();
        ctx.fillStyle = x;
        ctx.fillRect(currX, currY, 2, 2);
        ctx.closePath();
        dot_flag = false;
      }
    }

    if (res == "up" || res == "out") {
      flag = false;
    }

    if (res == "move") {
      if (flag) {
        prevX = currX;
        prevY = currY;
        currX = clientX - canvas.getBoundingClientRect().left;
        currY = clientY - canvas.getBoundingClientRect().top;
        draw();
      }
    }
  }
</script>

<body onload="init()">
  <div id="app" style="height: 100%">
    <canvas id="can"
      onresize="() => {canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight    }"></canvas>
    <div class="options">
      <div class="menu-header">Materials</div>
      <div class="colors">
        <div class="select-colour" title="Sky" style="background: rgb(121, 231, 245)" onclick="color(event)"></div>
        <div class="select-colour" title="Cloud" style="background: rgb(97, 126, 123)" onclick="color(event)"></div>
        <div class="select-colour" title="Hill" style="background: rgb(59, 222, 138)" onclick="color(event)"></div>
        <div class="select-colour" title="Mountain" style="background: rgb(138, 122, 92)" onclick="color(event)"></div>
        <div class="select-colour" title="Water" style="background: rgb(172, 194, 254)" onclick="color(event)"></div>
        <div class="select-colour" title="Mud" style="background: rgb(147, 53, 13)" onclick="color(event)"></div>
        <div class="select-colour" title="Fog" style="background: rgb(74, 198, 178)" onclick="color(event)"></div>
        <div class="select-colour" title="Snow" style="background: rgb(135, 216, 255)" onclick="color(event)"></div>
        <div class="select-colour" title="Sea" style="background: rgb(131, 206, 207)" onclick="color(event)"></div>
        <div class="select-colour" title="River" style="background: rgb(141, 171, 251)" onclick="color(event)"></div>
        <div class="select-colour" title="Flower" style="background: rgb(134, 0, 142)" onclick="color(event)"></div>
        <div class="select-colour" title="Grass" style="background: rgb(70, 202, 0)" onclick="color(event)"></div>
        <div class="select-colour" title="Straw" style="background: rgb(125, 231, 99)" onclick="color(event)"></div>
        <div class="select-colour" title="Bush" style="background: rgb(88, 115, 43)" onclick="color(event)"></div>
        <div class="select-colour" title="Forest" style="background: rgb(144, 212, 50)" onclick="color(event)"></div>
        <div class="select-colour" title="Stone" style="background: rgb(161, 83, 52)" onclick="color(event)"></div>
        <div class="select-colour" title="Sand" style="background: rgb(152, 148, 0)" onclick="color(event)"></div>
        <div class="select-colour" title="Gravel" style="background: rgb(131, 84, 84)" onclick="color(event)"></div>
        <div class="select-colour" title="Dirt" style="background: rgb(117, 74, 26)" onclick="color(event)"></div>
        <div class="select-colour" title="Stone wall" style="background: rgb(171, 174, 119)" onclick="color(event)">
        </div>
      </div>
      <div>Eraser</div>
      <div class="select-colour" onclick="ctx.globalCompositeOperation = 'destination-out'; x='white'"
        style="background: white; border: 2px solid" id="white"></div>
      <div class="buttons">
        <input type="button" class="btn btn-primary" value="Submit" id="download" size="23" onclick="download()"
          class="" />
        <input type="button" class="btn btn-light" value="Clear" id="clr" size="23" onclick="erase()" class="" />
      </div>
    </div>
  </div>
</body>

</html>